<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful | Resrvetia</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Confetti Animation -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Backend API Service (for tickets & QR codes) -->
    <script src="js/api-service.js"></script>

    <style>
        :root {
            --brand-primary: #ec4899;
            --brand-dark: #db2777;
            --bg-body: #000000;
            --bg-card: #0f172a;
            --bg-card-hover: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --text-white: #ffffff;
            --success: #10b981;
            --border-light: rgba(255, 255, 255, 0.1);
            --radius-lg: 16px;
            --font-main: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 50% 0%, #831843, #000000 60%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            padding-top: 90px;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background: transparent;
            backdrop-filter: blur(0);
            border-bottom: 1px solid transparent;
            height: 70px;
            display: flex;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
            height: 100%;
        }

        .logo {
            position: absolute;
            left: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-white);
            cursor: pointer;
            text-decoration: none;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--brand-dark);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
        }

        .payment-container {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 24px;
            max-width: 600px;
            width: 100%;
            padding: 50px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--success), #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            position: relative;
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3);
            animation: scaleIn 0.5s ease-out 0.2s both;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        .success-icon i {
            font-size: 3.5rem;
            color: white;
        }

        .success-icon::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success), #059669);
            opacity: 0.2;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.2;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.1;
            }
        }

        h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .payment-details {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: left;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .detail-row.total {
            padding-top: 20px;
            margin-top: 10px;
            border-top: 2px solid var(--brand-primary);
        }

        .detail-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .detail-value {
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .detail-row.total .detail-value {
            color: var(--brand-primary);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .transaction-id {
            background: rgba(236, 72, 153, 0.1);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
        }

        .transaction-id label {
            display: block;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-family: var(--font-main);
        }

        .transaction-id code {
            color: var(--brand-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            padding: 16px 30px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand-dark), var(--brand-primary));
            color: white;
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(236, 72, 153, 0.5);
        }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: white;
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .info-note {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 30px;
            font-size: 0.9rem;
            color: var(--text-muted);
            display: flex;
            align-items: start;
            gap: 12px;
            text-align: left;
        }

        .info-note i {
            color: var(--success);
            font-size: 1.2rem;
            margin-top: 2px;
        }

        /* QR Code Card */
        .qr-card {
            margin-top: 24px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 16px;
        }
        .qr-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .qr-list {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
        }
        .qr-item {
            flex: 1 1 160px;
            max-width: 190px;
        }
        .qr-body {
            position: relative;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border-radius: 12px;
            background: rgba(0,0,0,0.25);
        }
        .qr-image {
            width: 160px;
            height: 160px;
            object-fit: contain;
            display: none;
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.4));
        }
        .qr-placeholder {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
        }
        .qr-placeholder-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--bg-card-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
        }
        .qr-placeholder-title { font-weight: 700; color: var(--text-white); }
        .qr-placeholder-text { font-size: 0.85rem; }
        .qr-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-top: 12px;
        }
        .qr-meta { display: flex; align-items: center; gap: 8px; }
        .qr-label { color: var(--text-muted); }

        @media (max-width: 600px) {
            .payment-container {
                padding: 40px 25px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <i class="fa-solid fa-gem"></i>
                </div>
                <span>Resrvetia<span style="color: var(--brand-primary)">Events</span></span>
            </a>
        </div>
    </nav>

    <div class="payment-container">
        <div class="success-icon">
            <i class="fa-solid fa-check"></i>
        </div>
        
        <h1>Payment Successful!</h1>
        <p class="subtitle">Your booking has been confirmed and payment processed successfully.</p>
        
        <div class="transaction-id">
            <label>Transaction ID</label>
            <code id="transactionId">TXN-LOADING...</code>
        </div>
        
        <div class="payment-details">
            <div class="detail-row">
                <span class="detail-label">Event</span>
                <span class="detail-value" id="eventTitle">Loading...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Number of Tickets</span>
                <span class="detail-value" id="ticketQuantity">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Date & Time</span>
                <span class="detail-value" id="bookingDate">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Method</span>
                <span class="detail-value">Credit Card •••• 4242</span>
            </div>
            <div class="detail-row total">
                <span class="detail-label">Total Paid</span>
                <span class="detail-value" id="totalAmount">$0</span>
            </div>
        </div>
        <!-- QR Codes Section: one QR per ticket -->
        <div class="qr-card">
            <div class="qr-header">
                <i class="fa-solid fa-qrcode"></i>
                <span>Ticket QR Codes</span>
            </div>
            <div id="qrCodeContainer" class="qr-list"></div>
        </div>
        
        <div class="action-buttons">
            <a href="user-dashboard.html" class="btn btn-primary">
                <i class="fa-solid fa-ticket"></i>
                View My Tickets
            </a>
            <a href="events.html" class="btn btn-secondary">
                <i class="fa-solid fa-calendar"></i>
                Browse Events
            </a>
        </div>
        
        <div class="info-note">
            <i class="fa-solid fa-circle-info"></i>
            <span>A confirmation email with your ticket details has been sent to your registered email address.</span>
        </div>
    </div>

    <script>
        // Generate random transaction ID (for display only)
        function generateTransactionId() {
            const prefix = 'TXN';
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `${prefix}-${timestamp}-${random}`;
        }

        async function loadBookingDetailsAndQRCodes() {
            const urlParams = new URLSearchParams(window.location.search);

            const ticketsParam = urlParams.get('tickets');
            const singleTicketId = urlParams.get('ticketId');
            const eventFromQuery = urlParams.get('event');
            const quantityFromQuery = urlParams.get('quantity');
            const totalFromQuery = urlParams.get('total');

            // Always set a visible transaction reference
            const txnId = generateTransactionId();
            document.getElementById('transactionId').textContent = txnId;

            // Collect ticket IDs from query string
            let ticketIds = [];
            if (ticketsParam) {
                ticketIds = ticketsParam.split(',').map(id => id.trim()).filter(Boolean);
            } else if (singleTicketId) {
                ticketIds = [singleTicketId];
            }

            let tickets = [];

            // If we have ticket IDs, load full ticket details from backend
            if (ticketIds.length > 0 && typeof TicketsAPI !== 'undefined') {
                const promises = ticketIds.map(async (id) => {
                    try {
                        return await TicketsAPI.getTicket(id);
                    } catch (error) {
                        console.error('Failed to load ticket', id, error);
                        return null;
                    }
                });
                tickets = (await Promise.all(promises)).filter(Boolean);
            }

            let finalEventTitle = 'Event';
            let finalQuantity = 1;
            let finalTotal = 0;

            if (tickets.length > 0) {
                finalQuantity = tickets.length;
                finalTotal = tickets.reduce((sum, t) => sum + parseFloat(t.price_paid || 0), 0);
                finalEventTitle = tickets[0].event_title || tickets[0].event?.title || decodeURIComponent(eventFromQuery || 'Event');
            } else {
                // Fallback to URL parameters when we don't have ticket details
                finalEventTitle = decodeURIComponent(eventFromQuery || 'Event');
                finalQuantity = parseInt(quantityFromQuery || '1', 10) || 1;
                finalTotal = parseFloat(totalFromQuery || '0') || 0;
            }

            // Set booking details
            document.getElementById('eventTitle').textContent = finalEventTitle;
            document.getElementById('ticketQuantity').textContent = String(finalQuantity);
            document.getElementById('totalAmount').textContent = `$${finalTotal.toFixed(2)}`;

            // Set current date and time
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('bookingDate').textContent = dateStr;

            // Render QR codes for each ticket (if we have them)
            if (tickets.length > 0) {
                await renderTicketQRCodes(tickets);
            }
        }

        // Confetti animation
        function celebrateSuccess() {
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                
                confetti(Object.assign({}, defaults, {
                    particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                }));
                confetti(Object.assign({}, defaults, {
                    particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                }));
            }, 250);
        }

        async function renderTicketQRCodes(tickets) {
            const container = document.getElementById('qrCodeContainer');
            if (!container) return;

            container.innerHTML = '';

            for (const ticket of tickets) {
                const item = document.createElement('div');
                item.className = 'qr-item';

                item.innerHTML = `
                    <div class="qr-body">
                        <img class="qr-image" alt="QR for ticket ${ticket.id}" />
                        <div class="qr-placeholder">
                            <div class="qr-placeholder-icon"><i class="fa-solid fa-qrcode"></i></div>
                            <div>
                                <div class="qr-placeholder-title">Generating QR...</div>
                                <div class="qr-placeholder-text">Ticket #${ticket.id} • Seat ${ticket.seat_label || ticket.seat_number || '-' }.</div>
                            </div>
                        </div>
                    </div>
                    <div class="qr-footer">
                        <div class="qr-meta">
                            <span class="qr-label">Ticket:</span>
                            <code>${ticket.id}</code>
                        </div>
                        <div class="qr-meta">
                            <span class="qr-label">Seat:</span>
                            <code>${ticket.seat_label || ticket.seat_number || '-' }</code>
                        </div>
                    </div>
                `;

                container.appendChild(item);

                // Fetch QR image from backend
                if (typeof TicketsAPI !== 'undefined' && typeof TicketsAPI.getTicketQR === 'function') {
                    try {
                        const blob = await TicketsAPI.getTicketQR(ticket.id);
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            const img = item.querySelector('.qr-image');
                            const placeholder = item.querySelector('.qr-placeholder');
                            if (img) {
                                img.src = url;
                                img.style.display = 'block';
                            }
                            if (placeholder) {
                                placeholder.style.display = 'none';
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load QR for ticket', ticket.id, error);
                    }
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBookingDetailsAndQRCodes();
            celebrateSuccess();
        });
    </script>
</body>
</html>
